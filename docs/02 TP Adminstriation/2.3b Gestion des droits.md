# Gestion des droits Linux 

## PrÃ©sentation du contexte professionnel

Vous venez dâ€™Ãªtre recrutÃ© chez **TechCorp**, une PME de 50 salariÃ©s spÃ©cialisÃ©e dans les services numÃ©riques.  
La direction vous a confiÃ© une mission un peu particuliÃ¨re pour votre arrivÃ©e :  
reprendre en main un serveur de fichiers Linux qui vient dâ€™Ãªtre â€œinstallÃ©â€ par un prestataire manifestement incompÃ©tent.

Les symptÃ´mes sont nombreux :  
- les commerciaux qui ne peuvent pas accÃ©der Ã  leurs documents,  
- les dÃ©veloppeurs qui se plaignent que â€œtout le monde peut lire le code sourceâ€,  
- les fichiers de la direction visibles par des personnes qui nâ€™auraient jamais dÃ» y avoir accÃ¨s,  
- les scripts dâ€™administration sont impossibles Ã  lancer,  
- plus tous ce qui n'a pas encore Ã©tÃ© dÃ©couvert...

Votre rÃ´le, en tant que stagiaire fraÃ®chement embauchÃ© au service **INFRA**, est de :
1. analyser lâ€™existant sans tout casser ;    
2. identifier les erreurs de droits et de structure ;
3. proposer et appliquer des corrections cohÃ©rentes avec lâ€™organisation de lâ€™entreprise ;
4. vÃ©rifier, pour chaque service (DEV, INFRA, COM, DIR), que les accÃ¨s correspondent bien Ã  ce qui est attendu.

Mais avant de commencer, rÃ©cupÃ©rez ce script et exÃ©cutez le en root sur votre VM. 

> [!NOTE] 
> Jouez le jeu, ne regardez pas ce que fait ce script ... de toute faÃ§on vous vous en doutez ... c'est un carnage !


```
#!/bin/sh
# Initialisation de l'env TP Alpine Linux

echo "=== Initialisation de l'environnement TechCorp ==="

# 1) CrÃ©ation des utilisateurs
USERS="mdupont acarlier lroux sbernard jmartin nlambert tgarcia dvasseur mthomas lhenry rduval jmorel admin1 admin2 invite1 invite2"


for u in $USERS; do
    if id "$u" >/dev/null 2>&1; then
        echo "Utilisateur $u dÃ©jÃ  existant, ignorÃ©."
    else
        echo "CrÃ©ation de lâ€™utilisateur $u ..."
        adduser -D "$u"     # -D = default, pas de questions
        echo "$u:achanger" | chpasswd
    fi
done

echo ">>> Tous les utilisateurs ont le mot de passe : achanger"


echo "CrÃ©ation des dossiers /srv/ ..."
mkdir -p /srv/dev
mkdir -p /srv/infra
mkdir -p /srv/commerciaux
mkdir -p /srv/direction
mkdir -p /srv/commun
mkdir -p /srv/backup_admins
chown root:root /srv/*
chmod 755 /srv/dev
chmod 755 /srv/infra
chmod 775 /srv/commerciaux
chmod 755 /srv/direction
chmod 777 /srv/commun
chmod 777 /srv/backup_admins
echo "CrÃ©ation des fichiers de test ..."
cat > /srv/dev/specs_API_client_XYZ.txt << 'EOF'
SpÃ©cifications API REST pour le client XYZ.
Contient des endpoints sensibles et des clÃ©s dâ€™accÃ¨s.
EOF

cat > /srv/dev/todo_refonte_back.log << 'EOF'
TODO refonte back-end :
- migrer framework
- supprimer endpoints obsolÃ¨tes
EOF

chmod 664 /srv/dev/specs_API_client_XYZ.txt
chmod 664 /srv/dev/todo_refonte_back.log

cat > /srv/infra/script_backup.sh << 'EOF'
#!/bin/sh
# Script de sauvegarde (incomplet)
echo "Backup en cours (simulation)..."
EOF

cat > /srv/infra/README_infra.txt << 'EOF'
Notes internes INFRA :
- Plan IP
- ProcÃ©dures d'intervention
- Scripts divers
EOF

chmod 644 /srv/infra/script_backup.sh
chmod 644 /srv/infra/README_infra.txt

cat > /srv/commerciaux/catalogue_2024.pdf << 'EOF'
Catalogue commercial 2024 - donnÃ©es internes TechCorp.
EOF

cat > /srv/commerciaux/liste_clients_confidentiel.csv << 'EOF'
client;contact;telephone;CA_estime
BigCorp;M.Dupont;+33 1 23 45 67 89;250000
StartupX;Mme Martin;+33 6 11 22 33 44;80000
EOF

chmod 666 /srv/commerciaux/catalogue_2024.pdf
chmod 666 /srv/commerciaux/liste_clients_confidentiel.csv

cat > /srv/direction/budget_previsionnel_2025.xlsx << 'EOF'
Budget prÃ©visionnel 2025 - ultra confidentiel.
EOF

cat > /srv/direction/strategies_fusion_acquisition.txt << 'EOF'
StratÃ©gies de fusion/acquisition - accÃ¨s strict direction.
EOF

chmod 644 /srv/direction/budget_previsionnel_2025.xlsx
chmod 644 /srv/direction/strategies_fusion_acquisition.txt

cat > /srv/commun/note_interne_migration.txt << 'EOF'
Migration rÃ©alisÃ©e par le prestataire "QuickIT". Travail incomplet.
EOF

cat > /srv/commun/tableau_suivi_projets.csv << 'EOF'
projet;service;etat
RefonteSite;DEV;en cours
VPNRemote;INFRA;Ã  tester
Campagne2024;COM;validÃ©
EOF

chmod 666 /srv/commun/note_interne_migration.txt
chmod 666 /srv/commun/tableau_suivi_projets.csv

cat > /srv/backup_admins/full_backup_2025-11-01.tar.gz << 'EOF'
Archive complÃ¨te (factice).
EOF

cat > /srv/backup_admins/sauvegarde_home_admin1.tar.gz << 'EOF'
Sauvegarde du home admin1 (factice).
EOF

chmod 777 /srv/backup_admins/full_backup_2025-11-01.tar.gz
chmod 777 /srv/backup_admins/sauvegarde_home_admin1.tar.gz

echo "=== Environnement massacrÃ© par le prestataire est prÃªt ==="
echo "=== La direction vous remercie .... "
```

Une fois le script exÃ©cutÃ©, nous allons pouvoir commencer.
## Les droits POSIX

Les systÃ¨mes Unix (dont Linux) utilisent un modÃ¨le de permissions appelÃ© **POSIX**.  
Il repose sur **trois catÃ©gories** dâ€™utilisateurs (user / group / other) et **trois permissions** (r / w / x).

Câ€™est la base absolument indispensable pour comprendre pourquoi un fichier est accessibleâ€¦ ou non.

### Les trois catÃ©gories dâ€™accÃ¨s

Chaque fichier (ou dossier) appartient Ã  :
- **user** â†’ son propriÃ©taire
- **group** â†’ un groupe dâ€™utilisateurs
- **other** â†’ tous les autres utilisateurs du systÃ¨me

Un fichier a donc **trois ensembles distincts de permissions**.

### Les trois permissions

- **r** (read) â†’ lire le fichier, ou lister le contenu dâ€™un dossier
- **w** (write) â†’ modifier un fichier, ou crÃ©er/supprimer dans un dossier
- **x** (execute) â†’ exÃ©cuter un programme, ou _entrer dans un dossier_

> Plus tard : nous verrons les **bits spÃ©ciaux** (SUID, SGID, Sticky Bit) qui ajoutent des comportements supplÃ©mentaires.

### Comment lire les droits ?

Prenons un exemple simple :
```
touch test.txt
ls -l test.txt
```
RÃ©sultat typique (si vous avez un autre rÃ©sultat pas de panique):
```
-rw-------    1 root     etudiants            0 Dec  1 16:07 test.txt
```
exemple :
`-rw-r-----  1 alice dev 428 Dec  1 16:07 rapport.txt`

![[Droits - teste presta.png]]

La premiÃ¨re colonne [-rw-------] reprÃ©sente l'ensemble des droits** du fichier.

Elle de dÃ©coupe en quatre blocs :
```
[-][rw-][---][---]
 |   |    |    |
 |   |    |    â””â”€â”€â”€ other  (autres utilisateurs)
 |   |    â””â”€â”€â”€â”€â”€â”€â”€â”€ group  (groupe propriÃ©taire)
 |   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ user   (propriÃ©taire)
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ type   (fichier, dossier, lienâ€¦)
```

InterprÃ©tation (de la gauche vers la droite):
- **type** : `-` â†’ c'est un fichier (pas un dossier)
- **user** : `rw-` â†’ le propriÃ©taire peut lire (read) et Ã©crire (write)
- **group** : `---` â†’ le groupe nâ€™a aucun droit
- **other** : `---` â†’ les autres nâ€™ont aucun droit

### Premiers constats possibles

GrÃ¢ce Ã  `ls -l`, vous pouvez dÃ¨s maintenant :
- identifier **qui possÃ¨de un fichier**,
- vÃ©rifier **Ã  quel groupe il appartient**,
- repÃ©rer **qui a le droit de lire, Ã©crire ou exÃ©cuter**,
    
> [!NOTE] Commandes utiles
> ls -l           # lire les droits, propriÃ©taires et groupes
> ls -ld dossier  # lire les droits du dossier lui-mÃªme
> stat fichier    # afficher des informations dÃ©taillÃ©es

**Travail demandÃ©**
1) A partir des commande que vous avez vu, remplissez le tableau suivant :

| Dossier          | PropriÃ©taire (user) | Groupe propriÃ©taire | droits (user) | droits (group) | droits (others) | risques |
| ---------------- | ------------------- | ------------------- | ------------- | -------------- | --------------- | ------- |
|                  |                     |                     |               |                |                 |         |
| /srv/commerciaux |                     |                     |               |                |                 |         |
| /srv/commun      |                     |                     |               |                |                 |         |
| /srv/dev         |                     |                     |               |                |                 |         |
| /srv/direction   |                     |                     |               |                |                 |         |
| /srv/infra       |                     |                     |               |                |                 |         |

2) Lister les comptes prÃ©sents sur le serveur. Sont-ils cohÃ©rent avec cette liste ? existe t-il d'autre comptes (user pas system) ?
	Voici la liste des employÃ©s 
		**Direction (DIR)**
		- `mdupont` (Marie Dupont) â€“ Directrice
		- `acarlier` (Antoine Carlier) â€“ Directeur adjoint
		**Commercial (COM)**
		- `lroux` (Laura Roux)
		- `sbernard` (SÃ©bastien Bernard) 
		- `jmartin` (Julie Martin)
		**DÃ©veloppement (DEV)**
		- `nlambert` (Nicolas Lambert) 
		- `tgarcia` (Thomas Garcia)
		- `dvasseur` (Daniel Vasseur)
		- `mthomas` (MaÃ«lle Thomas)
		- `lhenry` (LoÃ¯c Henry)
		**Infrastructure (INFRA)**
		- `rduval` (Romain Duval)
		- `jmorel` (Julie Morel)

3) Les comptes sont-ils associÃ©s Ã  un groupe service ?  
4) Le script de backup est-il exÃ©cutable ?
5) Le catalogue commercial est-il modifiable par tout le monde ?
6) Le budget est lisible uniquement par la direction ?
7) Le readme dÃ©veloppeur peut-il  Ãªtre modifiÃ© par un commercial ?
    

> [!NOTE] Travail demandÃ©  
> Ã‰tudier la situation et expliquer pour 2 fichiers,  
> â†’ **ce qui va**  
> â†’ **ce qui ne va pas**  
> â†’ **qui doit avoir quoi**

Aucune correction pour lâ€™instant.

## CrÃ©ation des groupes mÃ©tiers et association des utilisateurs

> [!warning] 
> **On ne peut pas rÃ©parer les accÃ¨s aux dossiers mÃ©tier tant que la structure des groupes nâ€™existe pas.**  
> 
> Et encore moins tant que les bons utilisateurs ne sont pas associÃ©s aux bons groupes.

### CrÃ©ation des groupes mÃ©tiers

Les services de TechCorp sont :
- **DEV** : dÃ©veloppement
- **INFRA** : administration systÃ¨me et rÃ©seau
- **COM** : service commercial
- **DIR** : direction

> [!NOTE] Travail demandÃ©
> CrÃ©er les quatre groupes correspondants.  
> Aucune option particuliÃ¨re nâ€™est nÃ©cessaire : un groupe POSIX simple suffit.

### Associer chaque utilisateur Ã  son groupe primaire

Une fois les groupes crÃ©Ã©s, rattachez :
- chaque dÃ©veloppeur au groupe **DEV**,
- chaque administrateur au groupe **INFRA**,
- chaque commercial au groupe **COM**,
- chaque membre de la direction au groupe **DIR**.


> [!NOTE] Travail demandÃ©
> Associez chaque utilisateur Ã  son groupe primaire **en modifiant son compte**, pas en ajoutant un groupe secondaire.

## Correction des droits POSIX
Avant de corriger les accÃ¨s aux rÃ©pertoires mÃ©tiers, il faut savoir comment modifier les droits POSIX.  
La commande `chmod` permet dâ€™ajouter ou de retirer des permissions sur les trois ensembles : **user**, **group**, **other**.

Le principe est simple :
- `chmod +â€¦` ajoute un droit ;
- `chmod -â€¦` retire un droit ;
- `u`, `g` et `o` dÃ©signent respectivement le propriÃ©taire, le groupe et les autres utilisateurs.

Par exemple :
- `chmod g+r` ajoute(+) la lecture(r) au groupe(g),
- `chmod o-x` retire(-) le droit d'exÃ©cution (si fichier) ou  d'accÃ¨s (si dossier) aux â€œotherâ€(o),
- `chmod u+w` ajoute(+) lâ€™Ã©criture(w) au propriÃ©taire(u).

### RÃ©paration de `/srv/commerciaux/`

**Constat :**
```
drwxrwxr-x    2 root     root   4096 Dec  3 14:12 commerciaux
```

A priori il y a deux problÃ¨mes :
1. le **groupe propriÃ©taire** est `root` au lieu de `com` ;
2. les permissions **laissent entrer et lire tous les utilisateurs** (`r-x` pour _others_).

Cela signifie quâ€™un dÃ©veloppeur, un admin ou mÃªme un invitÃ© peut parcourir ce dossier â€” ce qui est inacceptable pour des donnÃ©es commerciales.

> [!NOTE]  
> La commande **`chown`** permet de corriger la propriÃ©tÃ© :
> 
> - `chown user fichier` â†’ change le propriÃ©taire
>     
> - `chown :groupe fichier` â†’ change le groupe propriÃ©taire
>     
> - `chown user:groupe fichier` â†’ change les deux en mÃªme temps
>     
> 
> Exemple :  
> `chown :com /srv/commerciaux/`  
> change uniquement le **groupe propriÃ©taire**.


> [!NOTE]  Travail demandÃ©
> 1. Donner au groupe **COM** le contrÃ´le du dossier `/srv/commerciaux/`
> 2. Restreindre totalement lâ€™accÃ¨s aux autres services
 

> Objectif :
> - COM â†’ lire, Ã©crire, entrer dans le dossier
> - autres â†’ aucun accÃ¨s, mÃªme pas lister son contenu

âœ Validez en testant lâ€™accÃ¨s avec un utilisateur COM et un utilisateur non-COM.

### RÃ©paration de `/srv/dev/`
Appliquer exactement la mÃªme dÃ©marche que pour `/srv/commerciaux/`, cette fois en attribuant le groupe propriÃ©taire **DEV**, puis en ajustant les droits pour que seuls les membres de ce groupe puissent entrer et travailler dans `/srv/dev/`.

### RÃ©paration de `/srv/direction/`
RÃ©aliser la correction en attribuant le groupe propriÃ©taire **DIR**.  
Le rÃ©pertoire de la direction doit Ãªtre **strictement rÃ©servÃ©** au groupe DIR, sans aucune permission pour les autres services.

### RÃ©paration de `/srv/infra/`
Corriger le rÃ©pertoire en attribuant le groupe propriÃ©taire **INFRA**.  
Les administrateurs doivent Ãªtre les seuls habilitÃ©s Ã  entrer dans `/srv/infra/` et Ã  modifier son contenu.

# ğŸŸ¥ **CHAPITRE 2 â€” umask**

## **2.1 Cas rÃ©el dans DEV**

**Constat**  
Les dÃ©veloppeurs crÃ©ent des fichiers dans `/srv/dev/` :  
ils apparaissent en 664 â†’ trop ouverts.

**Travail demandÃ©**  
Appliquer un umask assurant :

- fichiers : 640
    
- dossiers : 750  
    pour tous les membres de DEV.
    

**Validation**  
CrÃ©er un fichier test en tant que DEV â†’ vÃ©rifier.

**Notion introduite :**  
umask = masque retirÃ© au mode POSIX par dÃ©faut  
(agissant _uniquement_ Ã  la crÃ©ation)



# ğŸŸ¥ **CHAPITRE 3 â€” Sticky Bit**

## **3.1 RÃ©paration de `/srv/commun/`**

**Constat**  
Les services dÃ©posent des documents dans `/srv/commun/` mais  
â†’ chacun peut supprimer le fichier des autres.

**Travail demandÃ©**  
Activer le Sticky Bit pour sÃ©curiser cet espace.

**Validation**  
DEV dÃ©pose un fichier ; COM ne doit pas pouvoir le supprimer.



# ğŸŸ¥ **CHAPITRE 4 â€” Setgid**

## **4.1 ProblÃ¨me de collaboration DEV**

**Constat**  
Dans `/srv/dev/`, les fichiers crÃ©Ã©s hÃ©ritent du groupe personnel de lâ€™utilisateur.  
Cela empÃªche les dÃ©veloppeurs de collaborer.

**Travail demandÃ©**  
Activer le setgid sur `/srv/dev/` pour assurer un groupe unique DEV sur tous les fichiers.

**Validation**  
CrÃ©er deux fichiers depuis deux comptes DEV â†’ vÃ©rifier le groupe.



# ğŸŸ¥ **CHAPITRE 5 â€” ACL**

## **5.1 AccÃ¨s directionnel sÃ©lectif**

**Constat**  
La direction doit lire certains documents commerciaux dans `/srv/commerciaux/ventes/`  
mais ne pas Ã©crire, et sans rejoindre le groupe COM.

**Travail demandÃ©**  
Mettre en place une ACL permettant lâ€™accÃ¨s en lecture seule pour DIR.

**Validation**  
DIR doit pouvoir lire, COM doit garder tous ses droits,  
INFRA et DEV doivent Ãªtre refusÃ©s.



# Mise en situation finale**

## **6.1 Cahier des charges complet**

Reprendre lâ€™ensemble du serveur et produire **une politique dâ€™accÃ¨s complÃ¨te**, conforme aux besoins mÃ©tier.

**Les Ã©tudiants doivent documenter :**

- ce quâ€™ils ont constatÃ©,
    
- ce quâ€™ils ont modifiÃ©,
    
- pourquoi,
    
- et comment ils ont validÃ©.
- 
# Quiz & erreurs professionnelles**

## **7.1 Ã‰tude de cinq erreurs rÃ©elles**

Sur des exemples d'accÃ¨s impossibles, de fuites d'information, ou de mauvaises permissions (fichiers sans x, dossiers sans x, umask trop permissif, etc.).

## **7.2 Questions finales**

Sous forme de diagnostics courts :  
â€œVoici les droits, voici lâ€™erreur â†’ que proposez-vous ?â€
