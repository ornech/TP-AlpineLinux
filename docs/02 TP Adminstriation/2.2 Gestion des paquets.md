# 2.2 Gestion des paquets

> [!cite] â˜• Ã€ la machine Ã  cafÃ© de CorpTech
> 
> >*Â« Dâ€™aprÃ¨s le prestataire, tous les logiciels Ã©taient installÃ©s.*
> >*Quand on lui a demandÃ©  les numÃ©ros de version, il a rÃ©pondu â€œles derniÃ¨res ..."* ðŸ§


> [!NOTE] *PrÃ©-requis*
> *Votre VM doit **impÃ©rativement** accÃ©der Ã  internet pour ce chapitre. Si c'est pas le cas rÃ©glez ce problÃ¨me avant d'aller plus loin.*

**Politique Alpine : une seule version par paquet**

Alpine applique un modÃ¨le minimaliste :

- seul le **dernier** build dâ€™un paquet est conservÃ© (_rolling repository_)
- les anciennes versions disparaissent    
- l'objectif est de simplifier, sÃ©curitÃ©, stockage minimal

**ConsÃ©quence :**  Impossible de reconstruire Ã  lâ€™identique une VM plusieurs mois aprÃ¨s si le paquet a Ã©tÃ© remplacÃ©.

## CohÃ©rence technique dâ€™une release
Tous les paquets dâ€™une release sont compilÃ©s avec :
- la mÃªme version de **musl** (librairie C)
- les mÃªmes bibliothÃ¨ques de base
- les mÃªmes options de compilation
- la mÃªme **ABI** (Application Binary Interface)

> [!cite] **ABI**  
> Lâ€™ABI dÃ©finit le protocole binaire entre un programme compilÃ© et les bibliothÃ¨ques (registres, pile, symbolesâ€¦).  Si lâ€™ABI change, un programme compilÃ© pour lâ€™ancienne **ne fonctionne plus** correctement :
> il ne parle plus le **mÃªme protocole binaire**.

## 2.2.1 Introduction (Alpine Package Keeper )

Alpine Linux utilise **apk** (_Alpine Package Keeper_) pour installer, mettre Ã  jour et supprimer des logiciels.  
Pour fonctionner correctement, apk repose sur **trois notions complÃ©mentaires** :

> [!cite] **Concepts essentiels**  
> **Mirror** : le **serveur** oÃ¹ sont stockÃ©s les paquets.  
> **Repository** : la **catÃ©gorie** de paquets (main, community, testing).  
> **Release** : une **version stable** dâ€™Alpine rassemblant des repositories cohÃ©rents.

## 2.2.2 Mirror: _oÃ¹ sont les paquets ?_
Un **mirror** (mirr) est un serveur contenant les paquets et leurs index.  
apk tÃ©lÃ©charge tout depuis cette adresse.

Exemples :
```
https://dl-cdn.alpinelinux.org/
https://mirror.example.org/alpine/
```

## 2.2.3 Repository â€” _comment sont organisÃ©s les paquets ?_
Un **repository** est une **catÃ©gorie** de paquets classÃ©e par niveau de stabilitÃ©:
- **main** â†’ paquets officiels, testÃ©s, stables
- **community** â†’ paquets fiables issus de la communautÃ©
- **testing** â†’ paquets expÃ©rimentaux (uniquement sur _edge_    

> [!NOTE]  
> **testing = instable.** Pas destinÃ© Ã  la production.

## 2.2.4 Release â€” _quelle version dâ€™Alpine ?_

Une **release** est un ensemble cohÃ©rent de packages : noyau, outils systÃ¨me et bibliothÃ¨ques **tous compilÃ©s ensemble**.

Deux familles de releases :
- **stable** : `v3.18`, `v3.19`, `v3.20`  
    â†’ versions figÃ©es, mises Ã  jour tous les 6 mois
- **edge** : rolling release  
    â†’ mise Ã  jour continue, rÃ©servÃ©e au dÃ©veloppement

> [!WARNING]  
> Les repositories dâ€™une release ne sont **pas compatibles** avec ceux dâ€™une autre.  
> **Ne jamais mÃ©langer :**  
> `v3.20/main` + `edge/main`
> 
> Source Alpine :  
> _â€œDo not enable Main/Community from stable and edge at the same time. Mixing can break your system.â€_

## 2.2.5 Exercices Ã  rendre

> [!help] **Question 1**  
> Que se passe-t-il si apk installe un paquet compilÃ© pour une autre release que celle de votre systÃ¨me ?

> [!help] **Question 2**  
> Que se passe-t-il si vous activez un repository dâ€™une autre release ?

> [!info] **Consigne**  
> Votre rÃ©ponse doit obligatoirement comporter :
> - **URL** (documentation Alpine)
> - **extrait citÃ©**
> - **votre explication**
>  
> Sources officielles :
>1. Repositories â€” [https://wiki.alpinelinux.org/wiki/Repositories](https://wiki.alpinelinux.org/wiki/Repositories)
>2. apk â€” [https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html](https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html)
>3. apk-tools â€” [https://gitlab.alpinelinux.org/alpine/apk-tools](https://gitlab.alpinelinux.org/alpine/apk-tools)

# Commandes essentielles
apk fournit un ensemble de commandes simples pour gÃ©rer les paquets.  
Voici les opÃ©rations indispensables Ã  maÃ®triser.
## Mise Ã  jour de la liste des paquets

``` bash
apk update
```

Met Ã  jour lâ€™index des paquets prÃ©sents dans les repositories que vous avez configurÃ©.

```
apk update
```

> [!NOTE]  
> Ã€ exÃ©cuter avant toute installation, surtout aprÃ¨s modification de `/etc/apk/repositories`.

## Installer un paquet
``` bash
apk add nginx
apk add nano openssh-server
```

TÃ©lÃ©charge et installe :
- le paquet
- ses dÃ©pendances
- les fichiers de configuration par dÃ©faut
    
> [!WARNING]  
> apk nâ€™installe **que ce qui existe** dans les repositories de votre release.  
> Si le paquet nâ€™existe plus â†’ erreur (politique Alpine).

## Supprimer un paquet
```
apk del nano
```

> [!NOTE] *Note*
> Contrairement aux distribution "Debian like" il nâ€™existe **pas** dâ€™Ã©quivalent Ã  `apt purge` avec Alpine Linux. Alpine considÃ¨re que seul un administrateur peut dÃ©terminer si un fichier de configuration doit Ãªtre conservÃ© ou non.

> [!cite] Handbook Alpine Linux
> Dans le Handbook (section _Working with apk â†’ Removing packages_) :
 > Source [https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html](https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html)
 > 
> *"DÃ©sinstalle le paquet **sans toucher aux fichiers modifiÃ©s** dans `/etc`."*

## Rechercher un paquet dans les dÃ©pÃ´ts

```
apk search nginx
apk search openssh
```

> [!NOTE]  
> Recherche uniquement dans les repositories configurÃ©s localement.

## Afficher les informations sur un paquet

```
apk info nginx
```

Retourne :
- version
- description
- dÃ©pendances
- fichiers installÃ©s
- licence

Pour voir les fichiers installÃ©s :
```
apk info -L openssh-server
```

## Lister les paquets installÃ©s

```
apk info
```

Liste **tous** les paquets installÃ©s.

## Mettre Ã  jour les paquets installÃ©s
```
apk upgrade
```

Met Ã  jour tous les paquets installÃ©s vers les versions disponibles sur les repositories configurÃ©s.

> [!DANGER]  
> Sur Alpine _stable_, un `apk upgrade` peut :
> 
> - casser la compatibilitÃ© dâ€™une VM construite plusieurs mois plus tÃ´t
>     
> - rendre impossible la rÃ©installation dâ€™un ancien paquet
>     
> 
> Ã€ nâ€™utiliser **que si vous maitrisez les impacts de changement de version pour vos applications**.

## VÃ©rifier lâ€™intÃ©gritÃ© des paquets installÃ©s

```
apk audit
```

DÃ©tecte les inconsistances :
- fichiers modifiÃ©s
- fichiers orphelins
- dÃ©pendances manquantes

## Nettoyer lâ€™espace disque

```
apk cache clean
```

Supprime les fichiers tÃ©lÃ©chargÃ©s du cache local.

## Exemple complet

### **Installer Nginx, vÃ©rifier, lister, puis dÃ©sinstaller**

```
apk update
apk add nginx
apk info nginx
apk info -L nginx
apk del nginx
```

#  A rendre
## Exercice 1
> [!help] **Exercice 1**  
> Cherchez quel paquet installe la commande `ssh-keygen`.  
> Donnez :
> - la commande utilisÃ©e
> - le paquet trouvÃ©    
> - sa version    
> - extrait de `apk info`
## Exercice 2
> [!help] **Exercice 2**  
> Installez `nginx`, listez ses fichiers, puis supprimez-le proprement.
## Exercice 3
> [!help] **Exercice 3**  
> Expliquez, documentation Ã  lâ€™appui, ce que fait `apk upgrade`.  
> Source obligatoire :  
> [https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html](https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html)