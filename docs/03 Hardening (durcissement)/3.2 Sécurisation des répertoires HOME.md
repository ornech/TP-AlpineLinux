# S√©curisation des r√©pertoires HOME sous Alpine Linux
## Introduction
Chaque utilisateur poss√®de un r√©pertoire personnel :
```
/home/<nom>
```

Ce r√©pertoire est suppos√© √™tre :
- **son espace priv√©**    
- contenant des documents, configurations, cl√©s SSH, etc.

Mais avec Alpine Linux, cet espace n‚Äôest **PAS priv√© par d√©faut**. Mais avant de corriger cela, on va essayer de comprendre **pourquoi**.
## Alpine utilise BusyBox
Les distributions classiques  comme Debian, Ubuntu, RHEL‚Ä¶) utilisent les outils GNU comme
- **GNU coreutils**    
-  **shadow-utils** (`useradd`, `userdel`, etc.)
- PAM
- `/etc/skel` pr√©-configur√©
- `/etc/login.defs`
- des politiques de permissions par d√©faut

> [!warning] Alpine et Busybox
> Alpine a **remplac√©**  les utilitaires GNU par BusyBox  et remplace les outils comme`adduser`, `addgroup`, `su`, etc. BusyBox est con√ßu pour √™tre petit, portable,  embarqu√©  ou pour tournier sur conteneur.  En aucun cas, il pr√©tend  fournir une politique de s√©curit√© pr√©d√©finie. 
> 
>  **L'activation d'une  politique de s√©curir√©, c‚Äôest le travail de l‚Äôadministrateur**.

> [!NOTE]
> Pour rappel, Alpine Linux privil√©gie une approche enti√®rement explicite : rien n‚Äôest activ√© sans une action volontaire de l‚Äôadministrateur.

## 2.2 BusyBox `adduser`
BusyBox `adduser`, comme  on l'a d√©ja vu permet de cr√©er les utilisateurs mais √©galement  les r√©pertoires HOME; C'est justement ce point point que l'on va analyser

Commencez par cr√©er un utilisateur `test`:
```
adduser test
```

V√©rifions les droits du r√©pertoire /home/tes :
```sh
ls -ld /home/test
drwxr-sr-x    2 test     test          4096 Nov 30 11:53 test
```

```sh
stat -c "%a %n" /home/test
2755 /home/test
```
Ce qui signifie :

| Droits | Class POSIX  | Explications                     |
| ------ | ------------ | -------------------------------- |
| rwx    | propri√©taire | lecture + √©criture + ex√©cution   |
| r-s    | groupe       | lecture + ex√©cution + **setgid** |
| r-x    | les autres   | lecture + ex√©cution              |

> [!NOTE] Le bit sp√©cial : `s`  (SGID)
> **setgid** (Set Group ID) est un **bit sp√©cial**  des permissions Unix.. 
> Cela signifie que :
> - tout fichier ou sous-dossier cr√©√© dans `/home/test` h√©ritera du **groupe `test`**,
> - au lieu d‚Äôh√©riter du groupe principal du processus.

En l‚Äô√©tat, les permissions (`2755`) du HOME cr√©√© par BusyBox `adduser` en font un r√©pertoire **accessible et traversable par tous les utilisateurs**.

Fessons un petit test. On va cr√©er un fichier `secret.txt` dans la home de l'utilisateur `test` et on ne va pas toucher les droits d√©finir par d√©faut de ce fichier. 
```sh
su - test
nano secret.txt # ajouter "mon mot de passe secret que personne ne voit"
ls -l
```

R√©sultat :
```
-rw-r--r--  1 test test  ... secret.txt
```

Visiblement que notre fichier est accessible par d√©faut en lecture pour tout le monde,  les droits **644**.

V√©rifions cela. Connectez vous avec le compte de alice et tentez d'ouvrir ce fichier  :
```sh
su - alice
cd /home/test
ls -la
cat secret.txt
```

R√©sultat : elle peut lire le contenu.

üëâ **Confidentialit√© compromise.**
l‚ÄôANSSI (document ANSSI-BP-028 ) rapelle que :
 - le umask influence directement les permissions des fichiers cr√©√©s
 - que des umask permissifs sont dangereux
 - qu‚Äôils doivent √™tre corrig√©s
    

## üîπ Recommandation R35

L‚ÄôANSSI recommande :

- **umask syst√®me = 0027**
    
- **umask utilisateur = 0077**
    

Cons√©quence :

- fichiers cr√©√©s ‚Üí 600 (priv√©s)
    
- dossiers cr√©√©s ‚Üí 700 (priv√©s)
    

üëâ Ces valeurs **garantissent la confidentialit√©**.

---

## üîπ Section 3.x ‚Äî Consistance des permissions

L‚ÄôANSSI explique les risques :

- erreurs `chmod -R`
    
- permissions incoh√©rentes
    
- r√©pertoires traversables
    
- fuites d‚Äôinformation par simple visibilit√© des noms de fichiers
    

---

# 5) Correction : rendre les HOME conformes ANSSI

Il faut s√©curiser **deux niveaux** :

---

## üü¶ 5.1 Niveau 1 : le umask (ce qui prot√®ge les fichiers)

### 1. Mettre un umask global strict dans `/etc/profile` :

```sh
echo "umask 027" >> /etc/profile
```

### 2. Mettre un umask strict pour les nouveaux utilisateurs dans `/etc/skel/.profile` :

Cr√©er le skel si n√©cessaire :

```sh
mkdir -p /etc/skel
chmod 700 /etc/skel
```

Puis :

```sh
echo "umask 077" > /etc/skel/.profile
chmod 600 /etc/skel/.profile
```

### 3. Tester :

```sh
su - test
umask
```

Doit afficher :

```
0077
```

Puis :

```sh
nano note.txt
ls -l note.txt
stat -c "%a %n" note.txt
```

Doit donner :

```
600 note.txt
```

üëâ **Conforme ANSSI R35.**

---

## üü¶ 5.2 Niveau 2 : la permission du HOME (ce que BusyBox ne g√®re pas)

### Important : le skel ne modifie PAS le mode du HOME.

Donc il faut le durcir **manuellement** :

```sh
chmod 700 /home/test
```

Ou automatiser via un script :

```sh
adduser "$1"
chmod 700 "/home/$1"
```

### V√©rification :

```sh
ls -ld /home/test
stat -c "%a %n" /home/test
```

Doit afficher :

```
700 /home/test
```

üëâ **Le HOME devient enfin priv√©.**

---

## üü¶ 5.3 V√©rification finale : s√©paration inter-utilisateurs

Depuis alice :

```sh
su - alice
cd /home/test
```

R√©sultat :

```
Permission denied
```

‚û° Isolation OK  
‚û° Confidentialit√© OK  
‚û° Conformit√© ANSSI OK

---

# 6) R√©sum√© final pour les √©tudiants

|√âl√©ment|Par d√©faut Alpine|Probl√®me|Correction|Source ANSSI|
|---|---|---|---|---|
|HOME|2755|Traversable|chmod 700|Section 6.5|
|umask|0022|Fichiers 644 ‚Üí fuite|umask 0077|R35|
|skel|absent|pas de politique|cr√©er `/etc/skel`|Section 3.x|
|`.profile`|absent|pas de umask perso|ajouter dans skel|R35|
|fichiers|644|lisibles par tous|600 via umask|R35|

---

# 7) Conclusion p√©dagogique

**BusyBox n‚Äôest pas un outil de s√©curit√© pr√™t √† l‚Äôemploi.**  
Il fournit un syst√®me minimaliste, sans automatisme, qui n√©cessite :
- r√©flexion,
- construction,
- mise en place manuelle de la politique de s√©curit√©.

Contrairement √† Debian/Ubuntu (shadow-utils), Alpine :
- ne cr√©e pas de HOME priv√©,
- ne fournit pas `/etc/skel`,
- n‚Äôapplique pas de umask s√©curis√©.

‚û° **C‚Äôest √† l‚Äôadministrateur de b√¢tir la politique.**  
‚û° Et c‚Äôest p√©dagogiquement id√©al pour comprendre l‚Äôarchitecture Unix.
