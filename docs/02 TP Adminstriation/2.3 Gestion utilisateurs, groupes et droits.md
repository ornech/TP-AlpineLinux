# 2.3 Gestion des utilisateurs, groupes et droits

## 2.3.1 Introduction
Dans un syst√®me Unix/Linux, un **compte utilisateur** n‚Äôest pas seulement un nom :  
il correspond √† un **identifiant num√©rique unique**, appel√© **UID** (_User ID_).  
De m√™me, chaque groupe poss√®de un **identifiant num√©rique**, le **GID** (_Group ID_).  
Ces identifiants permettent au noyau de diff√©rencier les comptes et de structurer leurs acc√®s.

> [!note] Selon _The Linux Programming Interface_ :
¬´ Every process has a set of associated numeric user identifiers (UIDs) and group identifiers (GIDs). ¬ª

Cela signifie qu‚Äôau moment o√π un utilisateur lance un programme,  le processus **h√©rite de l‚ÄôUID et du GID** du compte qui l‚Äôex√©cute.  

**Pourquoi est-ce indispensable √† comprendre pour g√©rer les utilisateurs ?**  
Parce que ces identifiants (UID/GID) sont les informations que le noyau utilisera plus tard  
pour v√©rifier si un processus est autoris√© ou non √† acc√©der √† un fichier ou √† une ressource.  

Ce m√©canisme est √† la base du fonctionnement du mod√®le de permissions POSIX utilis√© par toutes les distributions Linux.

> [!NOTE]  En r√©sum√© :
> - Chaque utilisateur poss√®de un UID (User ID).;
> - Chaque groupe poss√®de un  GID  (Group ID).;
> - Un processus h√©rite de ces identifiants ;
> - Ces identifiants seront utilis√©s par le noyau pour √©valuer les permissions (point d√©velopp√© plus loin dans le TP).
> - **UID, GID et appartenance aux groupes**  constituent la base de la gestion des utilisateurs sous Unix/Linux.

##  2.3.2 Les fichiers syst√®mes li√©s aux utilisateurs
Pour fonctionner, la gestion des comptes s‚Äôappuie sur plusieurs fichiers de configuration.  
Ils ne doivent jamais √™tre modifi√©s √† la main dans un environnement de production, mais il est indispensable d‚Äôen conna√Ætre le r√¥le.

**Fichier `/etc/passwd`**
Ce fichier r√©pertorie **l‚Äôensemble des comptes du syst√®me** (comptes utilisateur et comptes syst√®me).  
Pour chaque compte, il indique :
- le **nom du compte** ; 
- son **UID** (_User ID_) ;
- son **GID principal** (_Group ID_) ;
- son **dossier personnel** ;
- son **shell de connexion**.

> [!NOTE]  
> Le mot du fichier ‚Äúpasswd‚Äù est historique : **les mots de passe n‚Äôy sont plus stock√©s** depuis longtemps.

Afficher le fichier `/etc/passwd` 
```
cat /etc/passwd
```

Vous devriez obtenir quelque chose comme ceci:
```
/home/etudiant # cat /etc/passwd
root:x:0:0:root:/root:/bin/sh
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/mail:/sbin/nologin
news:x:9:13:news:/usr/lib/news:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin
cron:x:16:16:cron:/var/spool/cron:/sbin/nologin
ftp:x:21:21::/var/lib/ftp:/sbin/nologin
sshd:x:22:22:sshd:/dev/null:/sbin/nologin
games:x:35:35:games:/usr/games:/sbin/nologin
ntp:x:123:123:NTP:/var/empty:/sbin/nologin
guest:x:405:100:guest:/dev/null:/sbin/nologin
nobody:x:65534:65534:nobody:/:/sbin/nologin
klogd:x:100:101:klogd:/dev/null:/sbin/nologin
etudiant:x:1000:1000::/home/etudiant:/bin/sh
```
On retrouve bien notre utilisateur `√©tudiant`.  
```
etudiant:x:1000:1000::/home/etudiant:/bin/sh
```
Pour Alpine Linux (comme toutes les distros Unix), la signification des champs est la m√™me :

|                  | Champ        | Signification                                   |
| ---------------- | ------------ | ----------------------------------------------- |
| `etudiant`       | login        | nom du compte                                   |
| `x`              | mot de passe | stock√© dans `/etc/shadow`                       |
| `1000`           | UID          | identifiant utilisateur du compte               |
| `1000`           | GID          | identifiant de groupe principal                 |
| vide             | info         | champ ‚Äúgecos‚Äù (description facultative)         |
| `/home/etudiant` | home         | emplacement du dossier personnel                |
| `/bin/sh`        | shell        | programme lanc√© automatiquement  √† la connexion |
**Fichier`/etc/shadow`**
Ce fichier contient les **empreintes de mots de passe** (hach√©es).  
Il est **strictement r√©serv√© au syst√®me** et n‚Äôest lisible que par `root`.

> [!NOTE]  
> Ce TP n‚Äôutilise pas `/etc/shadow`, mais le mentionner √©vite la confusion classique :  
> **les mots de passe ne sont jamais stock√©s dans `/etc/passwd`.**

**Fichier `/etc/group`**
Ce fichier r√©pertorie **tous les groupes du syst√®me**. Pour chaque groupe, il indique :
- le **nom** du group;
- son **GID** (_Group ID_) ;
- la liste des **membres** faisant partie de ce groupe.
```
cat /etc/group
```

Remarquez la ligne concernant le groupe `wheel`
```
 wheel:x:10:root,etudiant
```
Rappelez-vous nous avons ajout√© l'utilisateur `etudiant` au groupe `wheel` pour qu'il soit autoris√© √† utilis√© la commande `sudo`. C'est pour cela que nous voyons l'utilisateur `etudiant` figur√© dans la liste des menbres de `wheel`.

# 2.3.2 Travaux dirig√©s
## 2.3.2.1 Cr√©ation des utilisateurs
La commande pour cr√©er un utilisateur est adduser. Pour afficher les options disponible de cette commande, tapez `adduser --help`
```
/home/etudiant #  adduser --help
BusyBox v1.37.0 (2025-08-05 16:40:33 UTC) multi-call binary.

Usage: adduser [OPTIONS] USER [GROUP]

Create new user, or add USER to GROUP

	-h DIR		Home directory
	-g GECOS	GECOS field
	-s SHELL	Login shell
	-G GRP		Group
	-S		Create a system user
	-D		Don't assign a password
	-H		Don't create home directory
	-u UID		User id
	-k SKEL		Skeleton directory (/etc/skel)

```

Mise en place d‚Äôune √©quipe de travail

Votre serveur Alpine doit accueillir une petite √©quipe :

|Compte|R√¥le|Exigence|
|---|---|---|
|**alice**|d√©veloppeuse|home standard|
|**bob**|administrateur junior|doit √™tre ajout√© √† _wheel_ + home personnalis√©|
|**invite**|invit√© temporaire|pas de shell, pas de mot de passe|
|**serviceapp**|service interne|compte syst√®me, pas de home|
|**stagiaire**|compte mal configur√© volontairement|√† diagnostiquer et r√©parer|
## **PARTIE 1 ‚Äî Cr√©ation et observation (le c≈ìur du TP)**

## 1) Cr√©er le compte **alice**

```sh
adduser alice
```

### V√©rifications essentielles

- UID, GID, home, shell :
    ```sh
    grep alice /etc/passwd
    id alice
    ```
    
Quels sont UID, groupe principale, home, et perm
    ‚úî UID > 1000  
    ‚úî groupe primaire = alice  
    ‚úî home = /home/alice  

## 2) Cr√©er le compte **bob** en tant qu‚Äôadministrateur junior

### √âtape 1 ‚Äî Cr√©er bob avec un home sur un stockage s√©par√©
```sh
adduser -h /data/bob bob
```
### √âtape 2 ‚Äî Donner les droits administrateur (wheel)
```sh
adduser bob wheel
```
### √âtape 3 ‚Äî Forcer un shell diff√©rent
```sh
adduser -s /bin/ash bob
```
### V√©rifications
- bob est dans wheel ?
    ```sh
    id bob
    ```
- bob a un shell diff√©rent ?
    ```sh
    grep bob /etc/passwd
    ```
- bob poss√®de bien `/data/bob` ?
    ```sh
    ls -ld /data/bob
    ```

## 3) Cr√©er **invite**, un compte temporaire **bloqu√© par d√©faut**

```sh
adduser -D -h /tmp/invite -s /sbin/nologin invite
```

### V√©rifications

- se connecter ‚Üí √©chec normal
    
    ```sh
    su - invite
    ```
    
- raison de l‚Äô√©chec ‚Üí analyser :
    
    - pas de mot de passe (`-D`)
        
    - shell `nologin` (`-s`)
        

üéØ Ici, les √©tudiants voient **concr√®tement** comment cr√©er un compte inutilisable.

---

## 4) Cr√©er **serviceapp**, un vrai compte de service

```sh
adduser -S -H serviceapp
```

### V√©rifications

```sh
id serviceapp
grep serviceapp /etc/passwd
```

Constats √† noter :

- UID < 1000 ‚Üí compte syst√®me
    
- pas de home (‚àíH)
    
- shell `nologin` (par d√©faut pour un compte syst√®me)
    

üéØ Un vrai cas d‚Äôusage utile en entreprise.

---

# üöß **PARTIE 2 ‚Äî Un vrai diagnostic (pas un exercice artificiel)**

On cr√©e volontairement un compte **mal configur√©** que les √©tudiants doivent r√©parer.

## 5) Cr√©er **stagiaire**, mais avec des erreurs volontaires

```sh
adduser -H -D -s /sbin/nologin stagiaire
```

### V√©rifications √† faire par l‚Äô√©tudiant

```sh
grep stagiaire /etc/passwd
su - stagiaire
ls -ld /home
```

### Constat attendu

stagiaire ne peut pas fonctionner, car :

- pas de mot de passe
    
- shell nologin
    
- pas de home r√©el
    
- shell non interactif
    

### Travail demand√© : corriger le compte

1. cr√©er un home :
    
    ```sh
    mkdir /home/stagiaire
    chown stagiaire:stagiaire /home/stagiaire
    ```
    
2. d√©finir un shell :
    
    ```sh
    chsh -s /bin/sh stagiaire
    ```
    
3. d√©finir un mot de passe :
    
    ```sh
    passwd stagiaire
    ```
    

üéØ Les √©tudiants **r√©parent un compte cass√©** ‚Üí comp√©tence essentielle SISR.

---

# üß∞ **PARTIE 3 ‚Äî Skeleton : configuration par d√©faut**

## 6) D√©ployer un skeleton pour les nouveaux utilisateurs du groupe projet
‚Üí fournir des fichiers initiaux aux nouveaux collaborateurs.
Cr√©er un r√©pertoire skeleton :

```sh
mkdir /etc/skel-projet
echo "Bienvenue dans le projet" > /etc/skel-projet/README.txt
```

Cr√©er un nouvel utilisateur :

```sh
adduser -k /etc/skel-projet clara
```

V√©rifier :

```sh
ls /home/clara
```


