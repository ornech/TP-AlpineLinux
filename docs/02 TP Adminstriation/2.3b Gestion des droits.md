# 1) Gestion des droits Linux 

## Présentation du contexte professionnel

Vous venez d’être recruté chez **TechCorp**, une PME de 50 salariés spécialisée dans les services numériques.  
La direction vous a confié une mission un peu particulière pour votre arrivée :  
reprendre en main un serveur de fichiers Linux qui vient d’être “installé” par un prestataire manifestement incompétent.

Les symptômes sont nombreux :  
- les commerciaux qui ne peuvent pas accéder à leurs documents,  
- les développeurs qui se plaignent que “tout le monde peut lire le code source”,  
- les fichiers de la direction visibles par des personnes qui n’auraient jamais dû y avoir accès,  
- les scripts d’administration sont impossibles à lancer,  
- plus tous ce qui n'a pas encore été découvert...

Votre rôle, en tant que stagiaire fraîchement embauché au service **INFRA**, est de :
-  analyser l’existant sans tout casser ;    
- identifier les erreurs de droits et de structure ;
- proposer et appliquer des corrections cohérentes avec l’organisation de l’entreprise ;
- vérifier, pour chaque service (DEV, INFRA, COM, DIR), que les accès correspondent bien à ce qui est attendu.

> [!warning] Don't panic
> Ce TP sera votre guide.

Mais avant de commencer, récupérez ce script et exécutez le en root sur votre VM. 

> [!NOTE] 
> Ne regardez pas trop ce que fait ce script ... vous vous en doutez un peu je pense ... c'est une vraie boucherie ... un carnage !

```
#!/bin/sh
# Initialisation de l'env TP Alpine Linux

echo "=== Initialisation de l'environnement TechCorp ==="

# 1) Création des utilisateurs
USERS="mdupont acarlier lroux sbernard jmartin nlambert tgarcia dvasseur mthomas lhenry rduval jmorel admin1 admin2 invite1 invite2"


for u in $USERS; do
    if id "$u" >/dev/null 2>&1; then
        echo "Utilisateur $u déjà existant, ignoré."
    else
        echo "Création de l’utilisateur $u ..."
        adduser -D "$u"     # -D = default, pas de questions
        echo "$u:achanger" | chpasswd
    fi
done

echo ">>> Tous les utilisateurs ont le mot de passe : achanger"


echo "Création des dossiers /srv/ ..."
mkdir -p /srv/dev
mkdir -p /srv/infra
mkdir -p /srv/commerciaux
mkdir -p /srv/direction
mkdir -p /srv/commun
mkdir -p /srv/backup_admins
chown root:root /srv/*
chmod 755 /srv/dev
chmod 755 /srv/infra
chmod 775 /srv/commerciaux
chmod 755 /srv/direction
chmod 777 /srv/commun
chmod 777 /srv/backup_admins
echo "Création des fichiers de test ..."
cat > /srv/dev/specs_API_client_XYZ.txt << 'EOF'
Spécifications API REST pour le client XYZ.
Contient des endpoints sensibles et des clés d’accès.
EOF

cat > /srv/dev/todo_refonte_back.log << 'EOF'
TODO refonte back-end :
- migrer framework
- supprimer endpoints obsolètes
EOF

chmod 664 /srv/dev/specs_API_client_XYZ.txt
chmod 664 /srv/dev/todo_refonte_back.log

cat > /srv/infra/script_backup.sh << 'EOF'
#!/bin/sh
# Script de sauvegarde (incomplet)
echo "Backup en cours (simulation)..."
EOF

cat > /srv/infra/README_infra.txt << 'EOF'
Notes internes INFRA :
- Plan IP
- Procédures d'intervention
- Scripts divers
EOF

chmod 644 /srv/infra/script_backup.sh
chmod 644 /srv/infra/README_infra.txt

cat > /srv/commerciaux/catalogue_2024.pdf << 'EOF'
Catalogue commercial 2024 - données internes TechCorp.
EOF

cat > /srv/commerciaux/liste_clients_confidentiel.csv << 'EOF'
client;contact;telephone;CA_estime
BigCorp;M.Dupont;+33 1 23 45 67 89;250000
StartupX;Mme Martin;+33 6 11 22 33 44;80000
EOF

chmod 666 /srv/commerciaux/catalogue_2024.pdf
chmod 666 /srv/commerciaux/liste_clients_confidentiel.csv

cat > /srv/direction/budget_previsionnel_2025.xlsx << 'EOF'
Budget prévisionnel 2025 - ultra confidentiel.
EOF

cat > /srv/direction/strategies_fusion_acquisition.txt << 'EOF'
Stratégies de fusion/acquisition - accès strict direction.
EOF

chmod 644 /srv/direction/budget_previsionnel_2025.xlsx
chmod 644 /srv/direction/strategies_fusion_acquisition.txt

cat > /srv/commun/note_interne_migration.txt << 'EOF'
Migration réalisée par le prestataire "QuickIT". Travail incomplet.
EOF

cat > /srv/commun/tableau_suivi_projets.csv << 'EOF'
projet;service;etat
RefonteSite;DEV;en cours
VPNRemote;INFRA;à tester
Campagne2024;COM;validé
EOF

chmod 666 /srv/commun/note_interne_migration.txt
chmod 666 /srv/commun/tableau_suivi_projets.csv

cat > /srv/backup_admins/full_backup_2025-11-01.tar.gz << 'EOF'
Archive complète (factice).
EOF

cat > /srv/backup_admins/sauvegarde_home_admin1.tar.gz << 'EOF'
Sauvegarde du home admin1 (factice).
EOF

chmod 777 /srv/backup_admins/full_backup_2025-11-01.tar.gz
chmod 777 /srv/backup_admins/sauvegarde_home_admin1.tar.gz

echo "=== L'environnement massacré par le prestataire est prêt ==="
echo "=== La direction vous remercie === "
```

Pour les plus fainéant:
```
su - root
nano env.sh
sh env.sh

....
=== L'environnement massacré par le prestataire est prêt ===
=== La direction vous remercie ===
```

Une fois le script exécuté, nous allons pouvoir commencer.
## Les droits POSIX

Les systèmes Unix (dont Linux) utilisent un modèle de permissions appelé **POSIX**.  
Il repose sur **trois catégories** d’utilisateurs (user / group / other) et **trois permissions** (r / w / x).

C’est la base absolument indispensable pour comprendre pourquoi un fichier est accessible… ou non.

### Les trois catégories d’accès

Chaque fichier (ou dossier) appartient à :
- **user** → son propriétaire
- **group** → un groupe d’utilisateurs
- **other** → tous les autres utilisateurs du système

Un fichier a donc **trois ensembles distincts de permissions**.

### Les trois permissions

- **r** (read) → lire le fichier, ou lister le contenu d’un dossier
- **w** (write) → modifier un fichier, ou créer/supprimer dans un dossier
- **x** (execute) → exécuter un programme, ou _entrer dans un dossier_

> Plus tard : nous verrons les **bits spéciaux** (SUID, SGID, Sticky Bit) qui ajoutent des comportements supplémentaires.

### Comment lire les droits ?

Prenons un exemple simple :
```
touch test.txt
ls -l test.txt
```
Résultat typique (si vous avez un autre résultat pas de panique):
```
-rw-------    1 root     etudiants            0 Dec  1 16:07 test.txt
```
exemple :
`-rw-r-----  1 alice dev 428 Dec  1 16:07 rapport.txt`

![[Droits - teste presta.png]]

La première colonne [-rw-------] représente l'ensemble des droits** du fichier.

Elle de découpe en quatre blocs :
```
[-][rw-][---][---]
 |   |    |    |
 |   |    |    └─── other  (autres utilisateurs)
 |   |    └──────── group  (groupe propriétaire)
 |   └───────────── user   (propriétaire)
 └───────────────── type   (fichier, dossier, lien…)
```

Interprétation (de la gauche vers la droite):
- **type** : `-` → c'est un fichier (pas un dossier)
- **user** : `rw-` → le propriétaire peut lire (read) et écrire (write)
- **group** : `---` → le groupe n’a aucun droit
- **other** : `---` → les autres n’ont aucun droit

### Premiers constats possibles

Grâce à `ls -l`, vous pouvez dès maintenant :
- identifier **qui possède un fichier**,
- vérifier **à quel groupe il appartient**,
- repérer **qui a le droit de lire, écrire ou exécuter**,
    
> [!NOTE] Commandes utiles
> ls -l           # lire les droits, propriétaires et groupes
> ls -ld dossier  # lire les droits du dossier lui-même
> stat fichier    # afficher des informations détaillées

**Travail demandé**
1) A partir des commande que vous avez vu, remplissez le tableau suivant :

| Dossier          | Propriétaire (user) | Groupe propriétaire | droits (user) | droits (group) | droits (others) | risques |
| ---------------- | ------------------- | ------------------- | ------------- | -------------- | --------------- | ------- |
|                  |                     |                     |               |                |                 |         |
| /srv/commerciaux |                     |                     |               |                |                 |         |
| /srv/commun      |                     |                     |               |                |                 |         |
| /srv/dev         |                     |                     |               |                |                 |         |
| /srv/direction   |                     |                     |               |                |                 |         |
| /srv/infra       |                     |                     |               |                |                 |         |

2) Lister les comptes présents sur le serveur. Sont-ils cohérent avec cette liste ? existe t-il d'autre comptes (user pas system) ?
	Voici la liste des employés 
		**Direction (DIR)**
		- `mdupont` (Marie Dupont) – Directrice
		- `acarlier` (Antoine Carlier) – Directeur adjoint
		**Commercial (COM)**
		- `lroux` (Laura Roux)
		- `sbernard` (Sébastien Bernard) 
		- `jmartin` (Julie Martin)
		**Développement (DEV)**
		- `nlambert` (Nicolas Lambert) 
		- `tgarcia` (Thomas Garcia)
		- `dvasseur` (Daniel Vasseur)
		- `mthomas` (Maëlle Thomas)
		- `lhenry` (Loïc Henry)
		**Infrastructure (INFRA)**
		- `rduval` (Romain Duval)
		- `jmorel` (Julie Morel)

3) Les comptes sont-ils associés à un groupe service ?  
4) Le script de backup est-il exécutable ?
5) Le catalogue commercial est-il modifiable par tout le monde ?
6) Le budget est lisible uniquement par la direction ?
7) Le readme développeur peut-il  être modifié par un commercial ?
    

> [!NOTE] Travail demandé  
> Étudier la situation et expliquer pour 2 fichiers,  
> → **ce qui va**  
> → **ce qui ne va pas**  
> → **qui doit avoir quoi**

Aucune correction pour l’instant.


> [!warning] 
> **On ne peut pas réparer les accès aux dossiers métier tant que la structure des groupes n’existe pas.**  
> 
> Et encore moins tant que les bons utilisateurs ne sont pas associés aux bons groupes.

# 2) Association utilisateur -> grupe
## Création des groupes métiers

Les services de TechCorp sont :
- **DEV** : développement
- **INFRA** : administration système et réseau
- **COM** : service commercial
- **DIR** : direction

> [!NOTE] Travail demandé
> Créer les quatre groupes correspondants.  
> Aucune option particulière n’est nécessaire : un groupe POSIX simple suffit.

## Attacher un utilisateur à son groupe

Une fois les groupes créés, rattachez :
- chaque développeur au groupe **DEV**,
- chaque administrateur au groupe **INFRA**,
- chaque commercial au groupe **COM**,
- chaque membre de la direction au groupe **DIR**.


> [!NOTE] Travail demandé
> Associez chaque utilisateur à son groupe primaire **en modifiant son compte**, pas en ajoutant un groupe secondaire.

# 3) Correction des droits POSIX
Avant de corriger les accès aux répertoires métiers, il faut savoir comment modifier les droits POSIX.  
La commande `chmod` permet d’ajouter ou de retirer des permissions sur les trois ensembles : **user**, **group**, **other**.

Le principe est simple :
- `chmod +…` ajoute un droit ;
- `chmod -…` retire un droit ;
- `u`, `g` et `o` désignent respectivement le propriétaire, le groupe et les autres utilisateurs.

Par exemple :
- `chmod g+r` ajoute(+) la lecture(r) au groupe(g),
- `chmod o-x` retire(-) le droit d'exécution (si fichier) ou  d'accès (si dossier) aux “other”(o),
- `chmod u+w` ajoute(+) l’écriture(w) au propriétaire(u).

## Réparation de `/srv/commerciaux/`

**Constat :**
```
drwxrwxr-x    2 root     root   4096 Dec  3 14:12 commerciaux
```

A priori il y a deux problèmes :
1. le **groupe propriétaire** est `root` au lieu de `com` ;
2. les permissions **laissent entrer et lire tous les utilisateurs** (`r-x` pour _others_).

Cela signifie qu’un développeur, un admin ou même un invité peut parcourir ce dossier — ce qui est inacceptable pour des données commerciales.

> [!NOTE]  
> La commande **`chown`** permet de corriger la propriété :
> 
> - `chown user fichier` → change le propriétaire
>     
> - `chown :groupe fichier` → change le groupe propriétaire
>     
> - `chown user:groupe fichier` → change les deux en même temps
>     
> 
> Exemple :  
> `chown :com /srv/commerciaux/`  
> change uniquement le **groupe propriétaire**.


> [!NOTE]  Travail demandé
> 1. Donner au groupe **COM** le contrôle du dossier `/srv/commerciaux/`
> 2. Restreindre totalement l’accès aux autres services
 

> Objectif :
> - COM → lire, écrire, entrer dans le dossier
> - autres → aucun accès, même pas lister son contenu

➜ Validez en testant l’accès avec un utilisateur COM et un utilisateur non-COM.

## Réparation de `/srv/dev/`
Appliquer exactement la même démarche que pour `/srv/commerciaux/`, cette fois en attribuant le groupe propriétaire **DEV**, puis en ajustant les droits pour que seuls les membres de ce groupe puissent entrer et travailler dans `/srv/dev/`.

## Réparation de `/srv/direction/`
Réaliser la correction en attribuant le groupe propriétaire **DIR**.  
Le répertoire de la direction doit être **strictement réservé** au groupe DIR, sans aucune permission pour les autres services.

## Réparation de `/srv/infra/`
Corriger le répertoire en attribuant le groupe propriétaire **INFRA**.  
Les administrateurs doivent être les seuls habilités à entrer dans `/srv/infra/` et à modifier son contenu.

## umask

**Constat**  
Les développeurs créent des fichiers dans `/srv/dev/` :  
ils apparaissent en 664 → trop ouverts.

**umask** signifie **User Mask** ou **Permission Mask**.  
C’est un **masque de permissions** appliqué automatiquement par un processus lorsqu’un fichier est crée .

> [!NOTE]
> **Le umask (User File-Creation Mode Mask)** est une valeur octale propre à chaque processus. Elle n’intervient **que lorsqu’un fichier ou un répertoire est créé** par ce processus : le umask est alors **soustrait** au mode POSIX par défaut afin de déterminer les **permissions finales** de l’objet nouvellement créé.  


Observez comment umask influence les permissions _au moment de la création_ d'un fichier
Démonstration
Affichez le umask actuel :
```
umask
```
Résultat attendu : 
- Pour un dossier : 777 – 022 = 755  
- Pour un fichier : 666 – 022 = 644

Créez un fichier
```
touch test1
ls -l test1
```

Changez le umask en 077
```
umask 077
```
Créez un second fichier :
```
touch test2
ls -l test2
```
Comparez les permissions.
- test1 → `rw-r--r--`
- test2 → `rw-------`

Pour rappel : 

> [!NOTE] umask = **attribut d’un processus**
>  - agit **uniquement lors de la création** de fichiers/répertoires
>  - fonctionne en **retirant** des permissions
>  - n’a **aucun effet après coup**
>  - ne protège pas si le dossier parent est trop permissif
>  - ne doit pas être considéré comme un mécanisme fort de sécurité



> [!NOTE]
> **“The umask is simply a process property. Nothing more, nothing less.”**  
> _(LKML – Linus Torvalds)_


**Travail demandé**  
Appliquer un umask assurant :

- fichiers : 640

- dossiers : 750  
    pour tous les membres de DEV.
    

**Validation**  
Créer un fichier test en tant que DEV → vérifier.

**Notion introduite :**  
umask = masque retiré au mode POSIX par défaut  
(agissant _uniquement_ à la création)



## Sticky Bit

###  Correction du `/srv/commun/`

**Constat**  
Les services déposent des documents dans `/srv/commun/` mais  
→ chacun peut supprimer le fichier des autres.

**Travail demandé**  
Activer le Sticky Bit pour sécuriser cet espace.

**Validation**  
DEV dépose un fichier ; COM ne doit pas pouvoir le supprimer.

## Setgid

### Problème de collaboration DEV

**Constat**  
Dans `/srv/dev/`, les fichiers créés héritent du groupe personnel de l’utilisateur.  
Cela empêche les développeurs de collaborer.

**Travail demandé**  
Activer le setgid sur `/srv/dev/` pour assurer un groupe unique DEV sur tous les fichiers.

**Validation**  
Créer deux fichiers depuis deux comptes DEV → vérifier le groupe.

## ACL

### Accès directionnel sélectif

**Constat**  
La direction doit lire certains documents commerciaux dans `/srv/commerciaux/ventes/`  
mais ne pas écrire, et sans rejoindre le groupe COM.

**Travail demandé**  
Mettre en place une ACL permettant l’accès en lecture seule pour DIR.

**Validation**  
DIR doit pouvoir lire, COM doit garder tous ses droits,  
INFRA et DEV doivent être refusés.


# 4) Mise en situation finale

## Cahier des charges complet

Reprendre l’ensemble du serveur et produire **une politique d’accès complète**, conforme aux besoins métier.

**Les étudiants doivent documenter :**
- ce qu’ils ont constaté,
- ce qu’ils ont modifié,
- pourquoi,
- et comment ils ont validé.

# Quiz & erreurs professionnelles

## Questions finales

Sous forme de diagnostics courts :  
“Voici les droits, voici l’erreur → que proposez-vous ?”
