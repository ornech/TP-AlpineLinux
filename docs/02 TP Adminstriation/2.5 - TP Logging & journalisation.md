# Journalisation sous Alpine Linux

_Comprendre les logs, leur production, leur stockage, et leur analyse._

# 1. Quâ€™est-ce quâ€™un log ?

Un **log** est un **message Ã©mis par un programme ou le noyau** pour indiquer :
- une action
- un Ã©vÃ©nement  
- une erreur  
- un avertissement  
- une information de fonctionnement

Un log rÃ©pond Ã  un besoin fondamental :  
 - ** Savoir ce quâ€™il sâ€™est passÃ© sur un systÃ¨me ** comme une authentification rÃ©ussie ou l'arrÃªt prÃ©maturÃ© dâ€™un service.
  
Câ€™est lâ€™outil de diagnostic systÃ¨me.

# 2. Quâ€™est-ce quâ€™un systÃ¨me de logs ?

Un **systÃ¨me de logs** est lâ€™ensemble des mÃ©canismes permettant :

1. **dâ€™envoyer** des logs (programmes â†’ syslog())
2. **de collecter** les logs (dÃ©mon syslogd)
3. **de stocker** les logs (fichiers persistants)
4. **de les rendre consultables** (tail, logread, journalctlâ€¦)
5. **dâ€™organiser leur rotation** pour ne pas remplir le disque

Sur Alpine Linux, ce systÃ¨me est volontairement **minimal, simple, lisible**.

# 3. `syslogd` : le dÃ©mon collecteur

`syslogd` est un **dÃ©mon** (processus en arriÃ¨re plan) chargÃ© de :
- recevoir les messages envoyÃ©s par les programmes  
- les horodater  
- leur attribuer une prioritÃ©  
- les enregistrer dans le fichier `/var/log/messages`  
- Ã©ventuellement stocker les messages en mÃ©moire (buffer ring)
  
Sous Alpine, `syslogd` vient de **BusyBox**, donc il est :  
âœ” lÃ©ger  
âœ” simple  
âœ” standard POSIX  
âœ” idÃ©al pour un environnement pÃ©dagogique

# 4. `syslog()` (POSIX) : comment un programme Ã©crit un log ?

Tous les programmes Unix possÃ¨dent la possibilitÃ© dâ€™Ã©crire des logs via la fonction **POSIX** 
syslog().

> [!note] POSIX:  Portable Operating System Interface  
> Câ€™est **un standard international** crÃ©Ã© par lâ€™IEEE qui dÃ©finit comment un systÃ¨me dâ€™exploitation **compatible UNIX** doit fonctionner :  
â†’ quelles fonctions il doit fournir,  
â†’ comment ces fonctions doivent se comporter,  
â†’ quelles API un programme peut appeler,  
â†’ quel comportement lâ€™OS doit garantir.
> `syslog()` est une fonction standard POSIX que _tout programme peut appeler_ pour envoyer un message au dÃ©mon syslogd.

Cette fonction :
- ajoute une **prioritÃ©** (info, warning, err, notice, â€¦)  
- envoie le message directement vers syslogd  
- garantit une **interface standardisÃ©e**
  
Câ€™est la base du systÃ¨me de logs Unix.  
Un navigateur web, sshd, nginx, cronâ€¦ peuvent tous utiliser `syslog()`.
```

# 5. `/var/log/messages` : le stockage persistant

Par dÃ©faut, Alpine Ã©crit _tous_ les logs dans :


/var/log/messages
```

Câ€™est un fichier **persistant** :  
 - les logs survivent au redÃ©marrage.

Lecture simple :

```sh
tail -f /var/log/messages
grep sshd /var/log/messages
```

Câ€™est lâ€™outil principal pour diagnostiquer un systÃ¨me Alpine.

# 6. Buffer ring (mÃ©moire) : RAM â€¢ FIFO â€¢ logread

Alpine propose un **second mÃ©canisme**, en plus du fichier :

## 6.1. Buffer ring : câ€™est quoi ?

Un **buffer circulaire (ring buffer)** est :
- un espace en **RAM**  
- de taille fixe  
- gÃ©rÃ© en **FIFO** (Â« premier arrivÃ©, premier sorti Â»)
  
Il permet :

âœ” de lire des logs rÃ©cents **sans toucher au disque**  
âœ” dâ€™afficher les logs mÃªme si `/var/log/messages` nâ€™est pas encore Ã©crit  
âœ” dâ€™Ãªtre trÃ¨s rapide (RAM vs disque)

## 6.2. Activation

Le buffer est **dÃ©sactivÃ© par dÃ©faut** (philosophie Alpine : rien nâ€™est activÃ© sans ordre explicite).

Pour lâ€™activer :

```
SYSLOGD_OPTS="-C16"
```

â†’ 16 = taille du buffer en unitÃ©s BusyBox

## 6.3. Consultation

```
logread
logread -f
```

# 7. Philosophie Alpine : minimalisme Ã©clairÃ©

Alpine applique une rÃ¨gle simple :

> **Rien nâ€™est activÃ© sans commande explicite.**

ConsÃ©quences :
- Pas de journalisation en RAM si on ne demande rien  
- Pas de rotation des logs par dÃ©faut  
- Peu de fichiers dans `/var/log`  
- Comportement lisible, explicitement contrÃ´lÃ©
  
Câ€™est une distribution parfaite pour apprendre **ce quâ€™est rÃ©ellement un systÃ¨me Unix**.

# 8. OpenRC : lancement et supervision du dÃ©mon syslogd

Alpine utilise **OpenRC** comme systÃ¨me dâ€™initialisation.

Le service syslog est dÃ©crit dans :

```
/etc/init.d/syslog
```

Avec :

```
command="/sbin/syslogd"
command_args="${SYSLOGD_OPTS} -n"
pidfile="/run/syslogd.pid"
```

### RÃ´le dâ€™OpenRC :

âœ” lancer syslogd  
âœ” gÃ©rer son pidfile  
âœ” redÃ©marrer le service  
âœ” afficher son Ã©tat (approximatif)

### Attention pÃ©dagogique :

OpenRC ne surveille pas le processus en continu.  
Il peut dire â€œstartedâ€ alors que le dÃ©mon nâ€™existe plus.

# 9. Rotation des logs : garder le systÃ¨me propre

Le fichier `/var/log/messages` devient vite volumineux.  
Solution standard : `logrotate`.

Principes :
- couper le fichier rÃ©guliÃ¨rement  
- compresser les anciens  
- limiter le nombre de versions  
- supprimer les plus anciens
  
Exemple simple :

```
/var/log/messages {
    rotate 5
    weekly
    compress
    missingok
}
```

# 10. A rendre



## ğŸ§ª TP1 â€“ Observer la production de logs

Objectif : voir ce que produit le systÃ¨me lors dâ€™un Ã©vÃ©nement SSH.

1. Dans un terminal :
    ```
    tail -f /var/log/messages
    ```
2. Ouvrez une nouvelle session SSH.
3. Observez les lignes ajoutÃ©es.
  
**Questions :**
- Quelles informations apparaissent ?  
- Quels champs sont prÃ©sents (date, service, PIDâ€¦) ?
  
## ğŸ§ª TP2 â€“ Analyse dâ€™un redÃ©marrage de service

1. Dans un terminal :
    ```
    tail -f /var/log/messages
    ```
    
2. RedÃ©marrez sshd :
    ```
    rc-service sshd restart
    ```
  
**Questions :**
- Quelles traces apparaissent ?  
- Le service signale-t-il un arrÃªt propre ? Un redÃ©marrage ?
  
## ğŸ§ª TP3 â€“ Modifier le niveau de log dâ€™un service

Dans `/etc/ssh/sshd_config`, activez :

```
LogLevel VERBOSE
```
1. RedÃ©marrez le service
    ```
    rc-service sshd restart
    ```
2. Reconnectez-vous en SSH.
  
**Questions :**
- Quelles lignes supplÃ©mentaires apparaissent dans `/var/log/messages` ?
  
## ğŸ§ª TP4 â€“ Activer le buffer ring et utiliser `logread`

1. Modifiez `/etc/conf.d/syslog` :
```
SYSLOGD_OPTS="-C16"
```
2. RedÃ©marrez :
```
rc-service syslog restart
```
3. Testez :
```
logread
logread -f
```

**Questions :**
- Que contient le buffer ?  
- Quelle diffÃ©rence entre `logread` et `tail -f /var/log/messages` ?
  
## ğŸ§ª TP5 â€“ Mettre en place la rotation des logs

1. Installez logrotate :
    ```
    apk add logrotate
    ```
    
2. CrÃ©ez un fichier `/etc/logrotate.d/messages`.
    
3. Configurez une rotation simple.
  
**Questions :**

- Combien de fichiers sont conservÃ©s ?  
- Comment vÃ©rifier la rotation ?
  
## ğŸ§ª TP6 â€“ Diagnostic complet du service syslog

1. VÃ©rifiez lâ€™Ã©tat OpenRC
    
    ```
    rc-service syslog status
    ```
    
2. VÃ©rifiez lâ€™Ã©tat rÃ©el
    
    ```
    ps -ef | grep syslog
    ```
    
3. Check du pidfile
    
    ```
    cat /run/syslogd.pid
    ```
  
**Questions :**

- Lâ€™Ã©tat OpenRC reflÃ¨te-t-il la rÃ©alitÃ© ?  
- Que se passe-t-il si le pidfile est absent ?
  
