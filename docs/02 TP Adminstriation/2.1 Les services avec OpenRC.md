# 2.1 Les services avec OpenRC

> [!cite] â˜• A la machine Ã  cafÃ© de CorpTech
> > _Â« Ã€ lâ€™Ã©poque, quand on demandait au prestataire si le serveur tournait, la discussion devenait soudainement assez floue...  Â»_

Donc avant dâ€™aller plus loin, on va poser les bases de ce quâ€™est rÃ©ellement un programme, un dÃ©mon, et comment un service est censÃ© fonctionner sur un systÃ¨me Alpine Linux.
## 2.1.1. Un programme
Dans un systÃ¨me Unix, un **programme** c'est simplement un fichier **exÃ©cutable** lancÃ© par un utilisateur, qui tourne tant que quelquâ€™un lâ€™utilise.

> [!example] Exemples
> ls
> nano
> ping
> python3

Donc un programme est un outil ponctuel :

-  Il dÃ©marre quand on le lance,
- Il sâ€™arrÃªte quand il a fini
- Et il est liÃ© au terminal qui l'a lancÃ©. Ce qui veut dire que tout programme lancÃ© depuis un terminal sera dÃ©truit si le terminal Ã  l'origine de son exÃ©cution est fermÃ© (hÃ©ritage des processus).
## 2.1.2. Un dÃ©mon (daemon)

Certains programmes doivent fonctionner **en continu** pour fournir une fonctionnalitÃ© au aux utilisateurs comme un service web (serveur apache2 ou nginx).

> [!NOTE]
> **Un dÃ©mon = un programme autonome qui tourne en arriÃ¨re sans avoir Ã©tÃ© lancÃ© depuis un terminal.**

> [!example] Exemples
> - `sshd` â†’ permet lâ€™exÃ©cution d'un Shell sÃ©curisÃ© Ã  distance
> - `crond` â†’ exÃ©cute les tÃ¢ches planifiÃ©es
> - `nginx` â†’ permet l'accÃ¨s Ã  des pages web
> - `syslogd` â†’ enregistre les logs

Donc a priori ces programmes devrait pouvoir:
- dÃ©marrer tout seul dÃ¨s que le systÃ¨me est prÃªt,
- fonctionner en arriÃ¨re-plan,
- et rester actifs mÃªme si aucun utilisateur ne les utilise.

Le problÃ¨me fondamental est que si un dÃ©mon dÃ©marre un peu quand il a envie, il y a de forte chance pour que l'environnement systÃ¨me ne soit pas encore prÃªt . Par exemple si :
- `sshd` se lance avant que me rÃ©seau ne soit initialisÃ©, son lancement Ã©chouera.    
- `nginx` Ã©chouera si le dossier de logs nâ€™est pas montÃ©.
- `crond` agira de faÃ§on incohÃ©rente si lâ€™heure nâ€™est pas encore rÃ©glÃ©e.

> [!NOTE]
> **Conclusion : un dÃ©mon seul ne sait pas quand dÃ©marrer ou quoi faire en cas d'Ã©chec.**

## 2.1.3. Le dÃ©marrage dâ€™un systÃ¨me Linux
Revenons sur la sÃ©quence de dÃ©marrage d'un OS (mÃªme si cela n'a aucun secret pour vous ...) Quand la machine sâ€™allume  :

1. L'UEFI initialise les pÃ©riphÃ©rique puis rend la main 
2. Le noyau Linux se charge .
3. Les systÃ¨mes de fichiers sont montÃ©s.
4. Les pilotes sâ€™initialisent.
5. Les interfaces rÃ©seau apparaissent.
6. Les dÃ©mons peuvent enfin dÃ©marrer.

> [!NOTE]
> Encore une fois un dÃ©mon ne sait pas dans quel ordre se placer dans cet ordre logique, d'autant plus qu'un dÃ©mon n'a pas de vue sur l'Ã©tat du systÃ¨me.
> **Il lui faut donc un chef dâ€™orchestre.**

![[2.2 TP Les services avec OpenRC.png]]
## 2.1.4. Pourquoi orchestrer les dÃ©mons ?
Comme on vient de le voir, sans orchestration, on obtiendrait des erreurs imprÃ©visibles les dÃ©mons s'activeraient dans un ordre alÃ©atoire, des dÃ©pendances entre dÃ©mons ne seraient pas respectÃ©es et au finale on obtiendrait un systÃ¨me instable impossible Ã  maintenir. 

Pour que tout fonctionne correctement, on a besoin d'un mÃ©canisme qui :
- organise les **dÃ©pendances** entre services,
- sait **dans quel ordre** dÃ©marrer les dÃ©mons,
- sait **quand** un dÃ©mon peut dÃ©marrer,
- sait **arrÃªter proprement** un dÃ©mon,
- sait **vÃ©rifier son Ã©tat**,
- sait **activer/dÃ©sactiver le dÃ©marrage automatique** d'un dÃ©mon .

Câ€™est le travail du **systÃ¨me dâ€™initialisation** (init system) et donc d'OpenRC 

## 2.1.5. OpenRC

OpenRC est le **chef dâ€™orchestre** de notre distribution Alpine Linux. Il fournit :

**âœ” Un cadre pour dÃ©crire chaque service**
 Chaque service possÃ¨de un script dans  /etc/init.d/ sachant :
  - comment dÃ©marrer,
  - comment arrÃªter,
  - de quoi dÃ©pend le service.

**âœ” Un systÃ¨me de dÃ©pendances**
Exemple :
```sh
depend() {
    need net
}
```
OpenRC en dÃ©duit automatiquement lâ€™ordre de dÃ©marrage.

**âœ” Un mÃ©canisme dâ€™auto-dÃ©marrage**
GrÃ¢ce aux runlevels :
```
/etc/runlevels/default/
rc-update add sshd
```

**âœ” Une interface uniforme pour gÃ©rer les services**
```
rc-service <service> start
rc-service <service> stop
rc-service <service> status
```

**âœ” Un arrÃªt propre du systÃ¨me**
OpenRC arrÃªte les services :
- dans le bon ordre,
- proprement,
- sans perte de donnÃ©es.

## 2.1.6. SynthÃ¨se

### Du programme â†’ au dÃ©mon â†’ orchestration â†’ OpenRC
1. **Un programme** est exÃ©cutÃ© ponctuellement.
2. **Un dÃ©mon** fonctionne en continu en arriÃ¨re-plan.
3. Un dÃ©mon Ã©choue si lâ€™environnement nâ€™est pas prÃªt.
4. Il faut donc **orchestrer lâ€™ordre de dÃ©marrage**.
5. Cette orchestration est assurÃ©e par le **systÃ¨me dâ€™initialisation**.
6. Sur Alpine Linux, ce rÃ´le est rempli par **OpenRC**.
7. OpenRC garantit un dÃ©marrage fiable, cohÃ©rent et contrÃ´lÃ©.

> [!summary] En rÃ©sumÃ©  
> Les dÃ©mons accomplissent les tÃ¢ches.  
> OpenRC organise leur exÃ©cution.


> [!NOTE] Pour info
>Par dÃ©faut sur **Alpine Linux**, le _Kernel Watchdog_ nâ€™est ni activÃ© ni configurÃ©. Ce mÃ©canisme du noyau Linux permet de redÃ©marrer automatiquement le systÃ¨me en cas de blocage irrÃ©cupÃ©rable (watchdog = Â« chien de garde Â»). Alpine ne lâ€™active pas par dÃ©faut, car son utilisation nÃ©cessite lâ€™installation dâ€™un dÃ©mon et de dÃ©pendances supplÃ©mentaires, ce qui augmenterait la surface dâ€™attaque. 
>Retenez simplement quâ€™il est possible dâ€™utiliser un mÃ©canisme pour surveiller **des services, processus ou ressources spÃ©cifiques**, mais celui-ci **nâ€™est pas activÃ© par dÃ©faut** et doit Ãªtre installÃ©/configurÃ© manuellement.

## 2.1.7. RÃ©fÃ©rences

> [!summary]
> 
> - Alpine Linux â€“ OpenRC  
>     [https://wiki.alpinelinux.org/wiki/OpenRC](https://wiki.alpinelinux.org/wiki/OpenRC)
>     
> - Gentoo â€“ OpenRC Handbook  
>     [https://wiki.gentoo.org/wiki/OpenRC](https://wiki.gentoo.org/wiki/OpenRC)
>         

## 2.1.8. Exercices

### ğŸ“ **Exercice 1 â€“ DÃ©couverte**

> [!warning] Ã€ rendre
> 
> 1. Listez **tous** les services disponibles.
>     
> 2. Listez les services activÃ©s au dÃ©marrage.
>     
> 3. Donnez le chemin exact du script `networking`.
>     
> 
> **Format attendu : commandes + rÃ©ponses.**

### ğŸ“ **Exercice 2 â€“ Manipulation**

> [!warning] Ã€ rendre
> 
> 1. DÃ©marrez `crond`.
>     
> 2. VÃ©rifiez son Ã©tat.
>     
> 3. Activez-le au dÃ©marrage.
>     
> 4. RedÃ©marrez la machine.
>     
> 5. VÃ©rifiez quâ€™il est bien lancÃ© aprÃ¨s reboot.
>     
> 
> **Format attendu : commandes + rÃ©ponses.**

### ğŸ“ **Exercice 3 â€“ Analyse**

> [!warning] Ã€ rendre
> 
> Expliquez la diffÃ©rence entre :
> 
> ```
> rc-service sshd start
> ```
> 
> et
> 
> ```
> rc-update add sshd
> ```
> 
> (Attendu : start = exÃ©cution immÃ©diate, add = dÃ©marrage automatique au prochain boot.)

### ğŸ“ **Exercice 4 â€“ Recherche documentaire**

> [!warning] Ã€ rendre
> 
> Ã€ partir des sources officielles Alpine :
> 
> âœ”ï¸ Expliquez le rÃ´le de :
> 
> - `/etc/init.d`
>     
> - `/etc/runlevels/default`
>     
> - `/etc/conf.d`
>     
> 
> âœ”ï¸ Citez les URLs et extraits pertinents.
