# 2.2 Gestion des paquets

> [!cite] â˜• Ã€ la machine Ã  cafÃ© de CorpTech
> 
> > _Â« Dâ€™aprÃ¨s le prestataire, tous les logiciels Ã©taient installÃ©s._  
> > _Quand on lui a demandÃ© les numÃ©ros de version, il a rÃ©pondu â€œles derniÃ¨res ...â€_ ðŸ§

> [!NOTE] _PrÃ©-requis_  
> _Votre VM doit **impÃ©rativement** accÃ©der Ã  internet pour ce chapitre. Si c'est pas le cas rÃ©glez ce problÃ¨me avant d'aller plus loin._

## Observation initiale du systÃ¨me

Avant toute explication, observez lâ€™Ã©tat rÃ©el du systÃ¨me.
```
cat /etc/apk/repositories
```

```
apk info busybox musl
```

```
apk info | wc -l
```

> [!NOTE]
> La commande `apk info | wc -l` affiche le **nombre de paquets installÃ©s**.  
> Le mÃ©canisme utilisÃ© pour compter sera Ã©tudiÃ© plus tard.

Constat :

- les repositories sont dÃ©finis dans un fichier texte 
- chaque paquet installÃ© possÃ¨de une **version prÃ©cise** ;
- aucune information de version Â« abstraite Â» nâ€™existe.
## 2.2.1 Introduction (Alpine Package Keeper)

Alpine Linux utilise **apk** (_Alpine Package Keeper_) pour installer, mettre Ã  jour et supprimer des logiciels.  
Pour fonctionner correctement, apk repose sur **trois notions complÃ©mentaires** :

> [!cite] **Concepts essentiels**  
> **Mirror** : le **serveur** oÃ¹ sont stockÃ©s les paquets.  
> **Repository** : la **catÃ©gorie** de paquets (main, community, testing).  
> **Release** : une **version stable** dâ€™Alpine rassemblant des repositories cohÃ©rents.

## 2.2.2 Mirror: _oÃ¹ sont les paquets ?_

Un **mirror** (mirr) est un serveur contenant les paquets et leurs index.  
apk tÃ©lÃ©charge tout depuis cette adresse.

Exemples :

```
https://dl-cdn.alpinelinux.org/
https://mirror.example.org/alpine/
```

## 2.2.3 Repository: _comment sont organisÃ©s les paquets ?_

Un **repository** est une **catÃ©gorie** de paquets classÃ©e par niveau de stabilitÃ© :

- **main** â†’ paquets officiels, testÃ©s, stables
- **community** â†’ paquets fiables issus de la communautÃ©
- **testing** â†’ paquets expÃ©rimentaux (uniquement sur _edge_

> [!NOTE]  
> **testing = instable.** Pas destinÃ© Ã  la production.

## 2.2.4 Release : _quelle version dâ€™Alpine ?_

Une **release** est un ensemble cohÃ©rent de packages : noyau, outils systÃ¨me et bibliothÃ¨ques **tous compilÃ©s ensemble**.

Deux familles de releases :

- **stable** : `v3.18`, `v3.19`, `v3.20`  
    â†’ versions figÃ©es, mises Ã  jour tous les 6 mois
- **edge** : rolling release  
    â†’ mise Ã  jour continue, rÃ©servÃ©e au dÃ©veloppement
    

> [!WARNING]  
> Les repositories dâ€™une release ne sont **pas compatibles** avec ceux dâ€™une autre.  
> **Ne jamais mÃ©langer :**  
> `v3.20/main` + `edge/main`
> 
> Source Alpine :  
> _â€œDo not enable Main/Community from stable and edge at the same time. Mixing can break your system.â€_

## Contrainte de version sur un paquet

Essayez dâ€™installer une version prÃ©cise dâ€™un paquet :
```
apk add nginx=1.22
```
RÃ©sultat:
```
fetch http://dl-cdn.alpinelinux.org/alpine/v3.22/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.22/community/x86_64/APKINDEX.tar.gz
ERROR: unable to select packages:
  nginx-1.28.0-r3:
    breaks: world[nginx=1.22]
```

Lâ€™installation Ã©choue; Seule la version nginx-1.28.0-r3 est installable, aucune version antÃ©rieure nâ€™est proposÃ©e.

## Politique Alpine : une seule version par paquet

Alpine applique un modÃ¨le minimaliste :

- seul le **dernier** build dâ€™un paquet est conservÃ© (_rolling repository_)
- les anciennes versions disparaissent
- l'objectif est de simplifier, sÃ©curitÃ©, stockage minimal

**ConsÃ©quence :** Impossible de reconstruire Ã  lâ€™identique (en terme de version) une VM plusieurs mois aprÃ¨s si un paquet a Ã©tÃ© mis Ã  jour.

## MÃ©lange de repositories (analyse)

Sans effectuer de modification sur votre systÃ¨me :

- observez les repositories configurÃ©s dans `/etc/apk/repositories`
- identifiez Ã  quelle release ils appartiennent

Ã€ partir de la documentation Alpine, expliquez **pourquoi** le mÃ©lange de releases peut rendre un systÃ¨me instable.

## 2.2.5 Exercices Ã  rendre


> [!help] **Question 1**  
> Que se passe-t-il si apk installe un paquet compilÃ© pour une autre release que celle de votre systÃ¨me ?

> [!help] **Question 2**  
> Que se passe-t-il si vous activez un repository dâ€™une autre release ?

> [!info] **Consigne**  
> Votre rÃ©ponse doit obligatoirement comporter :
> 
> - **URL** (documentation Alpine)
>     
> - **extrait citÃ©**
>     
> - **commande exÃ©cutÃ©e**
>     
> - **votre explication**
>     

Sources officielles :

1. Repositories â€” [https://wiki.alpinelinux.org/wiki/Repositories](https://wiki.alpinelinux.org/wiki/Repositories)
2. apk â€” [https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html](https://docs.alpinelinux.org/user-handbook/0.1a/Working/apk.html)
3. apk-tools â€” [https://gitlab.alpinelinux.org/alpine/apk-tools](https://gitlab.alpinelinux.org/alpine/apk-tools)
    
# Commandes essentielles

apk fournit un ensemble de commandes simples pour gÃ©rer les paquets.  
Voici les opÃ©rations indispensables Ã  maÃ®triser.

## Mise Ã  jour de la liste des paquets

```bash
apk update
```

Met Ã  jour lâ€™index des paquets prÃ©sents dans les repositories que vous avez configurÃ©s.

> [!NOTE]  
> Ã€ exÃ©cuter avant toute installation, surtout aprÃ¨s modification de `/etc/apk/repositories`.

## Installer un paquet

```bash
apk add nginx
apk add nano openssh-server
```

TÃ©lÃ©charge et installe :

- le paquet
- ses dÃ©pendances
- les fichiers de configuration par dÃ©faut


> [!WARNING]  
> apk nâ€™installe **que ce qui existe** dans les repositories de votre release.  
> Si le paquet nâ€™existe plus â†’ erreur (politique Alpine).


## Supprimer un paquet

```
apk del nano
```

> [!NOTE]  
> Contrairement aux distributions Â« Debian like Â», il nâ€™existe **pas** dâ€™Ã©quivalent Ã  `apt purge` avec Alpine Linux.

=== Je ne vois pas ce que Ã§a apporte, si pas de dÃ©monstration ===
> [!cite] Handbook Alpine Linux  
> _"DÃ©sinstalle le paquet **sans toucher aux fichiers modifiÃ©s** dans `/etc`."_


## Mettre Ã  jour les paquets installÃ©s

```
apk upgrade
```

Avant exÃ©cution :
```
apk info nginx
```

AprÃ¨s exÃ©cution :
```
apk info nginx
```

=== Pourquoi ??? ===
> [!DANGER]  
> Sur Alpine _stable_, un `apk upgrade` peut :
> 
> - casser la compatibilitÃ© dâ€™une VM construite plusieurs mois plus tÃ´t
>     
> - rendre impossible la rÃ©installation dâ€™un ancien paquet
>     
> 
> Aucune procÃ©dure de retour arriÃ¨re nâ€™est fournie par apk.


## VÃ©rifier lâ€™intÃ©gritÃ© des paquets installÃ©s
=== A quoi Ã§a sert concrÃ¨tement ===
```
apk audit
```

Ã€ utiliser **aprÃ¨s** modification manuelle de fichiers ou incident systÃ¨me.

## Nettoyer lâ€™espace disque

```
apk cache clean
```

Ã€ utiliser **aprÃ¨s plusieurs installations / suppressions** pour constater lâ€™impact disque.

# A rendre

## Exercice 1

> Cherchez quel paquet installe la commande `ssh-keygen`.

## Exercice 2

> Installez `nginx`, listez ses fichiers, puis supprimez-le proprement.

## Exercice 3

> Expliquez, documentation Ã  lâ€™appui, ce que fait `apk upgrade`.  
> Justifiez **dans quel cas un administrateur ne doit pas lâ€™utiliser**.
